<a routerLink="/questions" class="back-link">&larr; Back to Questions</a>

<div class="question-detail-page" *ngIf="question; else loading">

  <!-- Question -->
  <section class="question-section">
    <div class="question-header">
      <h1>{{ question.title }}</h1>

      <div class="question-meta">
        <div class="meta-item">
          Asked on {{ question.dateCreated | date:'medium' }}
        </div>
        <div class="meta-item">
          by {{ question.createdByDisplayName || question.createdByEmail }}
        </div>
      </div>
    </div>

    <div class="question-body">
      <p>{{ question.body }}</p>
    </div>
  </section>

  <!-- Answers -->
  <section class="answers-section">
    <h2>
      Answers
      <span class="answer-count">{{ answers.length }}</span>
    </h2>

    <div *ngIf="answers.length > 0; else noAnswers">
      <div *ngFor="let answer of answers; trackBy: trackByAnswerId" class="answer-card">

        <!-- Vote Section -->
        <div class="vote-section">
          <button
            type="button"
            class="vote-btn upvote"
            (click)="voteOnAnswer(answer.id, true)"
            [disabled]="votingInProgress || hasVoted(answer.id)"
            [class.voted]="hasVoted(answer.id)">
            ▲
          </button>

          <span class="vote-score"
                [class.positive]="answer.voteScore > 0"
                [class.negative]="answer.voteScore < 0">
            {{ answer.voteScore }}
          </span>

          <button
            type="button"
            class="vote-btn downvote"
            (click)="voteOnAnswer(answer.id, false)"
            [disabled]="votingInProgress || hasVoted(answer.id)"
            [class.voted]="hasVoted(answer.id)">
            ▼
          </button>

          <small *ngIf="hasVoted(answer.id)" class="voted-label">Voted!</small>
        </div>

        <!-- Answer Content -->
        <div class="answer-content">
          <div class="answer-body">
            {{ answer.body }}
          </div>

          <div class="answer-meta">
            <span>Answered on {{ answer.dateCreated | date:'medium' }}</span>
            <span>by {{ answer.createdByDisplayName || answer.createdByEmail }}</span>
          </div>
        </div>

      </div>
    </div>

    <ng-template #noAnswers>
      <p class="empty-state">No answers yet. Be the first to answer!</p>
    </ng-template>
  </section>

  <!-- Your Answer -->
  <section class="answer-form">
    <h3>Your Answer</h3>

    <ng-container *ngIf="currentUser$ | async as user; else loginToAnswer">
    <form [formGroup]="answerForm" (ngSubmit)="submitAnswer()">
      <div class="form-group">
        <label for="answerBody" class="form-label">Your Answer</label>
        <textarea
          id="answerBody"
          class="form-control"
          formControlName="body"
          rows="6"
          placeholder="Share your knowledge..."></textarea>
      </div>

      <div class="form-group">
        <label for="answerCreatedBy" class="form-label">Your Email</label>
        <input
          id="answerCreatedBy"
          class="form-control"
          type="email"
          formControlName="createdBy"
          readonly/>
      </div>

      <button class="btn btn-primary" type="submit" [disabled]="answerForm.invalid">
        Post Your Answer
      </button>
    </form>
  </ng-container>
  
   <ng-template #loginToAnswer>
    <p class="empty-state">You must be logged in to post an answer.</p>
    <a
      class="btn btn-primary"
      [routerLink]="['/login']"
      [queryParams]="{ returnUrl: router.url }">
      Login to Answer
    </a>
  </ng-template>
  </section>

</div>

<ng-template #loading>
  <p class="loading">Loading question...</p>
</ng-template>
